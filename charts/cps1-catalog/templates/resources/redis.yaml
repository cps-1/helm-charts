{{- if has "redis" .Values.includeResources }}
apiVersion: cps1.tech/v1alpha1
kind: ResourceSet
metadata:
  name: redis
spec:
  label: Redis
  icon:
    svg: |
      {{- .Files.Get "images/redis.svg" | nindent 6 }}
  description: >-
    Redis is a in-memory storage, used as a distributed, in-memory key-value
    database, cache and message broker, with optional durability.
  input:
    - name: version
      label: Version
      kind: select
      required: true
      values: {{- toYaml .Values.resources.redis.version.values | nindent 8 }}
      default: "{{ .Values.resources.redis.version.default }}"
    - name: minmemory
      label: Minimum Memory
      tip: |
        How much memory in Megabytes should be reserved for this Redis
        instance
      kind: number
      required: true
      default: '64'
    - name: maxmemory
      label: Maximum Memory
      tip: |
        How much memory in Megabytes this Redis instance can consume. If
        it extrapolates this value the database will restart.
      kind: number
      required: true
      default: '256'
    - name: mincpu
      label: Minimum CPU
      tip: |
        How much CPU time in milliCPUs should be reserved for this Redis
        instance
      kind: number
      required: true
      default: '50'
    - name: maxcpu
      label: Maximum CPU
      tip: |
        How much CPU time in milliCPUs this Redis instance can consume. If
        it extrapolates this value the database process will experience CPU
        throttling.
      kind: number
      required: true
      default: '500'
  output:
    - name: host
      source: ${svc.name}.${svc.namespace}.svc.cluster.local
  resources:
    - id: deploy
      template:
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          labels:
            app.kubernetes.io/name: ${deploy.name}-deployment
            app.kubernetes.io/instance: ${deploy.name}
        spec:
          replicas: 1
          selector:
            matchLabels:
              app.kubernetes.io/name: ${deploy.name}-deployment
              app.kubernetes.io/instance: ${deploy.name}
          template:
            metadata:
              labels:
                app.kubernetes.io/name: ${deploy.name}-deployment
                app.kubernetes.io/instance: ${deploy.name}
            spec:
              containers:
                - image: redis:${input.version}-bookworm
                  name: redis
                  resources:
                    requests:
                      memory: ${input.minmemory}Mi
                      cpu: ${input.mincpu}m
                    limits:
                      memory: ${input.maxmemory}Mi
                      cpu: ${input.maxcpu}m
                  ports:
                    - containerPort: 6379
                      name: redis
                      protocol: TCP
    - id: svc
      template:
        apiVersion: v1
        kind: Service
        spec:
          ports:
            - name: redis
              port: 6379
              protocol: TCP
              targetPort: 6379
          selector:
            app.kubernetes.io/name: ${deploy.name}-deployment
            app.kubernetes.io/instance: ${deploy.name}
{{- end }}
